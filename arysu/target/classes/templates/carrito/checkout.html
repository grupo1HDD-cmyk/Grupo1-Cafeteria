<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${title}">Confirmar Compra - Aroma y Sueños</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}"> 
</head>
<body> 

    <div class="container py-5">
        <h1 class="mb-4">Confirmar tu Compra</h1>
        <p>¡Felicidades! Estás a punto de completar tu pedido.</p>
        <p>Aquí verás el detalle de los productos en tu carrito, el total, y las opciones para finalizar la compra.</p>

        <!-- Mensajes de éxito/error generales (si los usas) -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Resumen del Pedido
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="checkout-cart-summary">
                    <li th:each="item : ${itemsCarrito}" class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span th:text="${item.nombre}" class="fw-bold">Nombre del Producto</span> 
                            x <span th:text="${item.cantidad}">Cantidad</span>
                        </div>
                        <span>S/ <span th:text="${#numbers.formatDecimal(item.precioTotal, 1, 2)}">0.00</span></span>
                    </li>
                    <li th:if="${#lists.isEmpty(itemsCarrito)}" class="list-group-item text-center text-muted">
                        Tu carrito está vacío. <a th:href="@{/menu}">¡Explora nuestros productos!</a>
                    </li>
                </ul>
                <div class="text-end fw-bold mt-3">
                    Total: <span id="checkout-total-display">S/ <span th:text="${#numbers.formatDecimal(totalCarrito, 1, 2)}">0.00</span></span>
                </div>
            </div>
        </div>

        <h2 class="mb-3">Información de Envío y Pago</h2>
        <form action="#" th:action="@{/carrito/procesar-pedido}" method="post"> 
            <!-- ¡LÍNEA DEL TOKEN CSRF ELIMINADA AQUÍ! (porque tu SecurityConfig tiene csrf.disable()) -->
            
            <div class="mb-3">
                <label for="address" class="form-label">Dirección de Envío</label>
                <!-- Eliminamos la referencia a currentUser.direccion, ya que no existe en la entidad Usuario. -->
                <input type="text" class="form-control" id="address" name="address" required>
            </div>
            <div class="mb-3">
                <label for="paymentMethod" class="form-label">Método de Pago</label>
                <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                    <option value="">Selecciona un método</option>
                    <option value="card">Tarjeta de Crédito/Débito</option>
                    <option value="paypal">PayPal</option>
                    <option value="yape">Yape</option>
                </select>
            </div>

            <button type="submit" class="btn btn-success btn-lg">Realizar Pedido</button>
            <a th:href="@{/carrito/ver}" class="btn btn-secondary ms-2">Volver al Carrito</a>
        </form>
    </div>

    <!-- Modal de Confirmación de Pedido -->
    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderSuccessModalLabel">Pedido Realizado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderSuccessModalBody">
                    <!-- El mensaje se inyectará aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a th:href="@{/}" class="btn btn-primary">Ir a Inicio</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script> 
    
    <!-- Script para mostrar el modal si hay un mensaje de éxito -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Verificar si existe el atributo flash 'successMessageForModal'
        var successMessage = /*[[${successMessageForModal}]]*/ null;
        if (successMessage) {
            document.getElementById('orderSuccessModalBody').innerText = successMessage;
            var orderSuccessModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
            orderSuccessModal.show();
        }

        // Si hubiera un mensaje de error (aunque con redirección a checkout ya tenemos error en la URL)
        var errorMessage = /*[[${errorMessageForModal}]]*/ null;
        if (errorMessage) {
            console.error("Error al procesar pedido:", errorMessage);
        }
        /*]]>*/
    </script>
</body>
</html>